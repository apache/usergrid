{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Usergrid AWS Cluster",
   "Parameters":{
     "KeyPair":{
        "Description":"EC2 key pair to be use for SSH access",
        "Type":"String",
        "Default":"comcast-key-pair"
     },
      "GraphiteInstanceType":{
         "Description":"Instance type for Graphite server",
         "Type":"String",
         "Default":"t1.micro",
         "AllowedValues":[
            "t1.micro",
            "m1.small",
            "m1.medium",
            "m1.large",
            "m3.large",
            "m1.xlarge",
            "m3.xlarge",
            "m3.2xlarge",
            "c3.4xlarge"
         ],
         "ConstraintDescription":"must be valid instance type."
      },
      "GraphiteServers":{
         "Description":"Minimum number of graphite servers. There should only be one",
         "Type":"Number",
         "Default":"1",
         "MinValue":"1"
      }
   },
   "Mappings":{
      "AWSInstanceType2Arch":{
         "t1.micro":{
            "Arch":"64"
         },
         "m1.small":{
            "Arch":"64"
         },
         "m1.medium":{
            "Arch":"64"
         },
         "m1.large":{
            "Arch":"64"
         },
         "m1.xlarge":{
            "Arch":"64"
         },
         "m3.large":{
            "Arch":"64"
         },
         "m3.xlarge":{
            "Arch":"64"
         },
         "c3.4xlarge":{
            "Arch":"64"
         }
      },
      "AWSRegionArch2AMI":{
         "ap-southeast-2":{
            "64":"ami-5993f663"
         },
         "us-east-1":{
            "64":"ami-7cbd4f14"
         },
         "us-west-2":{
            "64":"ami-2598ea15"
         }
      },
      "TwoAZs":{
         "ap-southeast-2":{
            "AZ1":"ap-southeast-2a",
            "AZ2":"ap-southeast-2b"
         },
         "us-east-1":{
            "AZ1":"us-east-1b",
            "AZ2":"us-east-1c"
         },
         "us-west-2":{
            "AZ1":"us-west-2a",
            "AZ2":"us-west-2b"
         }
      }
   },
   "Resources":{
     "RootRole":{
        "Type":"AWS::IAM::Role",
        "Properties":{
           "AssumeRolePolicyDocument":{
              "Statement":[
                 {
                    "Effect":"Allow",
                    "Principal":{
                       "Service":[
                          "ec2.amazonaws.com"
                       ]
                    },
                    "Action":[
                       "sts:AssumeRole"
                    ]
                 }
              ]
           },
           "Path":"/"
        }
     },
     "RolePolicies":{
        "Type":"AWS::IAM::Policy",
        "Properties":{
           "PolicyName":"root",
           "PolicyDocument":{
              "Statement":[
                 {
                    "Effect":"Allow",
                    "Action":"*",
                    "Resource":"*"
                 }
              ]
           },
           "Roles":[
              {
                 "Ref":"RootRole"
              }
           ]
        }
     },
     "RootInstanceProfile":{
        "Type":"AWS::IAM::InstanceProfile",
        "Properties":{
           "Path":"/",
           "Roles":[
              {
                 "Ref":"RootRole"
              }
           ]
        }
     },
      "GraphiteUser":{
         "Type":"AWS::IAM::User",
         "Properties":{
            "Path":"/",
            "Policies":[
               {
                  "PolicyName":"root",
                  "PolicyDocument":{
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":"*",
                           "Resource":"*"
                        }
                     ]
                  }
               }
            ]
         }
      },
      "GraphiteKey":{
         "Type":"AWS::IAM::AccessKey",
         "Properties":{
            "UserName":{
               "Ref":"GraphiteUser"
            }
         }
      },
      "GraphiteInstance":{
         "Type":"AWS::EC2::Instance",
         "Properties":{
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "",
                     [
                        "#!/bin/bash -x\n",
                        "sudo git clone https://github.com/hopsoft/docker-graphite-statsd.git \n",
                        "sudo ./docker-graphite-statsd/bin/start \n",
                        "sudo git clone https://github.com/dotcloud/collectd-graphite.git \n",
                        "sudo collectd-graphite/docker build -t collectd-graphite . \n"
                     ]
                  ]
               }
            },
            "KeyName":{
               "Ref":"KeyPair"
            },
            "ImageId":{
               "Fn::FindInMap":[
                  "AWSRegionArch2AMI",
                  {
                     "Ref":"AWS::Region"
                  },
                  {
                     "Fn::FindInMap":[
                        "AWSInstanceType2Arch",
                        {
                           "Ref":"GraphiteInstanceType"
                        },
                        "Arch"
                     ]
                  }
               ]
            },
            "InstanceType":{
               "Ref":"GraphiteInstanceType"
            },
            "IamInstanceProfile":{
               "Ref":"RootInstanceProfile"
            },
            "SecurityGroups":[
               "graphite"
            ]
         }
      }
   }
}
